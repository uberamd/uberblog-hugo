<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>haproxy consul template generation with docker registrator mesosphere and marathon :: steves ramblings</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Odds are if you&amp;rsquo;ve stumbled across this post it&amp;rsquo;s because you&amp;rsquo;re running into the same issue I had: your docker-backed services are using the wrong IP in Consul-Template. Assuming your workflow looks like this:
 Commit code change CI server triggers a docker image build Image is pushed to registry and API call is made to Marathon to deploy application Marathon deploys the docker container with bridged networking, assigns it a random IP Registrator detects the new container and registers the service with Consul Consul template picks up the new container and should add another host to the HAProxy config Oh shit, it doesn&amp;rsquo;t work :(  I&amp;rsquo;m guessing step 6 is where the wheels come off for you." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://www.stevem.io/post/haproxy-consul-template-generation-with-docker-registrator-mesosphere-and-marathon/" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-79548225-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" href="https://www.stevem.io/assets/style.css">

  <link rel="stylesheet" href="https://www.stevem.io/assets/green.css">






<link rel="apple-touch-icon" href="https://www.stevem.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://www.stevem.io/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="haproxy consul template generation with docker registrator mesosphere and marathon">
<meta property="og:description" content="Odds are if you&amp;rsquo;ve stumbled across this post it&amp;rsquo;s because you&amp;rsquo;re running into the same issue I had: your docker-backed services are using the wrong IP in Consul-Template. Assuming your workflow looks like this:
 Commit code change CI server triggers a docker image build Image is pushed to registry and API call is made to Marathon to deploy application Marathon deploys the docker container with bridged networking, assigns it a random IP Registrator detects the new container and registers the service with Consul Consul template picks up the new container and should add another host to the HAProxy config Oh shit, it doesn&amp;rsquo;t work :(  I&amp;rsquo;m guessing step 6 is where the wheels come off for you." />
<meta property="og:url" content="https://www.stevem.io/post/haproxy-consul-template-generation-with-docker-registrator-mesosphere-and-marathon/" />
<meta property="og:site_name" content="steves ramblings" />

  
    <meta property="og:image" content="https://www.stevem.io/img/favicon/green.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2016-06-09 02:04:55 -0600 -0600" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    steves ramblings
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://www.stevem.io/post/haproxy-consul-template-generation-with-docker-registrator-mesosphere-and-marathon/">haproxy consul template generation with docker registrator mesosphere and marathon</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2016-06-09 
      </span>
    
    
    <span class="post-author">:: Steve Morrissey</span>
    
  </div>

  

  

  

  <div class="post-content"><div>
        <p><img src="/img/visu-ovh-docker-lab.jpg" alt="Docker Consul Marathon"></p>
<p>Odds are if you&rsquo;ve stumbled across this post it&rsquo;s because you&rsquo;re running into the same issue I had:  your docker-backed services are using the wrong IP in Consul-Template. Assuming your workflow looks like this:</p>
<ol>
<li>Commit code change</li>
<li>CI server triggers a docker image build</li>
<li>Image is pushed to registry and API call is made to Marathon to deploy application</li>
<li>Marathon deploys the docker container with bridged networking, assigns it a random IP</li>
<li>Registrator detects the new container and registers the service with Consul</li>
<li>Consul template picks up the new container and should add another host to the HAProxy config</li>
<li>Oh shit, it doesn&rsquo;t work :(</li>
</ol>
<p>I&rsquo;m guessing step 6 is where the wheels come off for you. Sure, consul-template is writing out the config file, but it&rsquo;s writing out the docker0 interface IP address instead of the IP of the Mesosphere Slave the container is running on, right? How do we fix this while still using Bridged networking? Quite simple, actually. Ensure your consul-template file for HAProxy looks similar to this:</p>
<pre><code>backend http_pool
  mode http
  balance roundrobin
  option forwardfor
  option httpchk GET /YOUR_HEALTH_CHECK_PATH{{range service &quot;YOUR_SERVICE_NAME&quot;}}
  server {{.Node}} {{with node .Node }}{{.Node.Address}}{{end}}:{{.Port}} check inter 3s fall 3 rise 2{{end}}
</code></pre><p>Important piece there is the final line which grabs the Node the service is running on and extracts the Address of the node itself. Most tutorials say to simply use .Address but as you likely discovered that&rsquo;ll leave you with the container IP, which isn&rsquo;t at all useful to you.</p>
<p>It&rsquo;s that simple!</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://www.stevem.io/post/containers-in-production/">
                <span class="button__icon">←</span>
                <span class="button__text">containers in production</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://www.stevem.io/post/unifi-wireless-metrics-with-sensu/">
                <span class="button__text">unifi wireless metrics with sensu</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2020 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://www.stevem.io/assets/main.js"></script>
<script src="https://www.stevem.io/assets/prism.js"></script>







  
</div>

</body>
</html>

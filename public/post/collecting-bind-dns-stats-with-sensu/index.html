<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>collecting bind dns stats with sensu :: steves ramblings</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Recently I migrated off of AWS Route53 to my own BIND servers for a few of my domains. I didn&amp;rsquo;t do this because I think I can do DNS better than the folks at Amazon. Instead, I&amp;rsquo;m looking to collect some detailed statistics about DNS usage and running my own DNS servers was the path of least resistance to reach that goal.
Prepping the DNS servers My DNS setup is fairly typical, with a master and slave DNS server, each one located on different sides of the US." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://www.stevem.io/post/collecting-bind-dns-stats-with-sensu/" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-79548225-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" href="https://www.stevem.io/assets/style.css">

  <link rel="stylesheet" href="https://www.stevem.io/assets/green.css">






<link rel="apple-touch-icon" href="https://www.stevem.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://www.stevem.io/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="collecting bind dns stats with sensu">
<meta property="og:description" content="Recently I migrated off of AWS Route53 to my own BIND servers for a few of my domains. I didn&amp;rsquo;t do this because I think I can do DNS better than the folks at Amazon. Instead, I&amp;rsquo;m looking to collect some detailed statistics about DNS usage and running my own DNS servers was the path of least resistance to reach that goal.
Prepping the DNS servers My DNS setup is fairly typical, with a master and slave DNS server, each one located on different sides of the US." />
<meta property="og:url" content="https://www.stevem.io/post/collecting-bind-dns-stats-with-sensu/" />
<meta property="og:site_name" content="steves ramblings" />

  
    <meta property="og:image" content="https://www.stevem.io/img/favicon/green.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2017-01-12 22:14:11 -0600 CST" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    steves ramblings
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://www.stevem.io/post/collecting-bind-dns-stats-with-sensu/">collecting bind dns stats with sensu</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2017-01-12 
      </span>
    
    
    <span class="post-author">:: Steve Morrissey</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://www.stevem.io/tags/sensu/">sensu</a>&nbsp;
    
    #<a href="https://www.stevem.io/tags/bind/">bind</a>&nbsp;
    
    #<a href="https://www.stevem.io/tags/monitoring/">monitoring</a>&nbsp;
    
    #<a href="https://www.stevem.io/tags/dns/">dns</a>&nbsp;
    
    #<a href="https://www.stevem.io/tags/grafana/">grafana</a>&nbsp;
    
    #<a href="https://www.stevem.io/tags/graphite/">graphite</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <p><a href="/img/bind-grafana-lead.png"><img src="/img/bind-grafana-lead.png" alt="grafana graph"></a></p>
<p>Recently I migrated off of AWS Route53 to my own BIND servers for a few of my domains. I didn&rsquo;t do this because I think I can do DNS better than the folks at Amazon. Instead, I&rsquo;m looking to collect some detailed statistics about DNS usage and running my own DNS servers was the path of least resistance to reach that goal.</p>
<h2 id="prepping-the-dns-servers">Prepping the DNS servers<a href="#prepping-the-dns-servers" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>My DNS setup is fairly typical, with a master and slave DNS server, each one located on different sides of the US. The master, <code>ns1.stevem.io</code>, is in New York, NY while the slave, <code>ns2.stevem.io</code> is in San Francisco, CA.</p>
<p>First thing to do is ensure statistics are enabled for BIND. In my <code>/etc/bind/named.conf.options</code> file on BOTH of my DNS servers I have:</p>
<pre><code>options {
    ...

    // enable statistics
    statistics-file &quot;named.stats&quot;;
    zone-statistics yes;
    
    ...
}

statistics-channels {
        inet 0.0.0.0 port 8080 allow { MY.EXTERNAL.IP.1; MY.EXTERNAL.IP.2; };
};
</code></pre><p>What this does is write a statistics file to <code>/var/cache/bind/named.stats</code> as well as enable the statistics HTTP endpoint on port <code>8080</code> from two external IP addresses. In this case I&rsquo;m having it bind to <code>0.0.0.0</code> so I can reach the stats page by hitting either one of the public IPs assigned to the DNS server.</p>
<p>After making this change I simply issued a <code>systemctl restart bind9</code> and things were working as intended. Visiting <code>http://ns1.stevem.io:8080/</code> in my web browser presented a formatted page of statistics, while using curl to grab that URL gave me raw XML. It&rsquo;s the XML that my script parses to build out the metrics.</p>
<h2 id="sensu-metric-script">Sensu Metric script<a href="#sensu-metric-script" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Now that our BIND servers are configured for statistic output on port 8080 we just need a script we can have a Sensu Client execute to begin gathering the metrics. I created a script named <code>metric-bind9-xml.rb</code> with the following contents:</p>
<pre><code>#! /usr/bin/env ruby

require 'rubygems' if RUBY_VERSION &lt; '1.9.0'
require 'sensu-plugin/metric/cli'
require 'nokogiri'
require 'open-uri'
require 'socket'
require 'uri'

class MetricBind &lt; Sensu::Plugin::Metric::CLI::Graphite
  option :url, short: '-u URL'
  option :scheme, short: '-s SCHEME', default: &quot;#{Socket.gethostname}.bind&quot;

  def run
    if !config[:url]
      # #YELLOW
      unknown 'No URL specified'
    end
    acquire_resource
  end

  def acquire_resource
    doc = Nokogiri::XML(open(config[:url]))
    uri = URI(config[:url])

    if uri.host
      config[:scheme] = &quot;#{uri.host}.bind&quot;
    end

    results = {}

    # store the qtype counters (query types)
    doc.xpath('//server//counters[@type=&quot;qtype&quot;]//counter').each do |row|
      results.store(&quot;counter.qtype.#{row.attr('name')}&quot;, row.text)
    end

    # store the nsstat counters
    doc.xpath('//server//counters[@type=&quot;nsstat&quot;]//counter').each do |row|
      results.store(&quot;counter.nsstat.#{row.attr('name')}&quot;, row.text)
    end

    # loop through zones
    doc.xpath('//views//view[@name=&quot;_default&quot;]//zones//zone').each do |zone|
      zone_name = zone.attr('name').gsub(/\./, '_')
      zone.xpath('counters//counter').each do |counter|
        results.store(&quot;zone.#{zone_name}.#{counter.attr('name')}&quot;, counter.text)
      end
    end

    results.each do |k,v|
      output &quot;#{config[:scheme]}.#{k}&quot;, v
    end

    ok

  end
end
</code></pre><p>This is a pretty simple script that uses the <code>nokogiri</code> gem to parse an XML document and grab relevant data for metric usage. It will grab the general stats, as well as stats for each zone, and return Graphite-formatted metrics results.</p>
<p>The Sensu Check definition looks like this:</p>
<pre><code>{
    &quot;checks&quot;: {
        &quot;ns1_stevem_io_bind_metrics&quot;: {
            &quot;type&quot;: &quot;metric&quot;,
            &quot;interval&quot;: 60,
            &quot;command&quot;: &quot;\/opt\/sensu-plugins\/plugins\/dns\/metrics-bind9-xml.rb -u http:\/\/ns1.stevem.io:8080\/&quot;,
            &quot;handlers&quot;: [
                &quot;graphite&quot;
            ],
            &quot;subscribers&quot;: [
                &quot;netmon&quot;
            ]
        },
        &quot;ns2_stevem_io_bind_metrics&quot;: {
            &quot;type&quot;: &quot;metric&quot;,
            &quot;interval&quot;: 60,
            &quot;command&quot;: &quot;\/opt\/sensu-plugins\/plugins\/dns\/metrics-bind9-xml.rb -u http:\/\/ns2.stevem.io:8080\/&quot;,
            &quot;handlers&quot;: [
                &quot;graphite&quot;
            ],
            &quot;subscribers&quot;: [
                &quot;netmon&quot;
            ]
        }
    }
}
</code></pre><p>Again, pretty simple. Every 60 seconds the script is run with a single parameter, <code>-u http://YOUR.NAME.SERVER.HERE:8080/</code> passed in. The result is handled by a <code>graphite</code> handler, and is executed by clients subscribing to <code>netmon</code>.</p>
<p>Sample output from a check run looks like this:</p>
<pre><code>ns1.stevem.io.bind.zone.stevem_io.SitMatch 0 1484282548
ns1.stevem.io.bind.zone.stevem_io.A 4033 1484282548
ns1.stevem.io.bind.zone.stevem_io.NS 18 1484282548
ns1.stevem.io.bind.zone.stevem_io.SOA 38 1484282548
ns1.stevem.io.bind.zone.stevem_io.MX 1 1484282548
ns1.stevem.io.bind.zone.stevem_io.TXT 1 1484282548
ns1.stevem.io.bind.zone.stevem_io.AAAA 2507 1484282548
ns1.stevem.io.bind.zone.stevem_io.SRV 16 1484282548
ns1.stevem.io.bind.zone.stevem_io.A6 2 1484282548
ns1.stevem.io.bind.zone.stevem_io.ANY 3 1484282548
</code></pre><h2 id="visualizing-with-grafana">Visualizing with Grafana<a href="#visualizing-with-grafana" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Assuming you&rsquo;re feeding these metrics into a Time Series Database such as Graphite, simply build out a query in Grafana to present the data in the way you determine works best. Personally, I have a couple graphs for the general stats, then one for each zone. I use stacked lines as the total number of queries I care about is a sum of A, AAAA, and CNAME requests.</p>
<p><a href="/img/bind-grafana-stats.png"><img src="/img/bind-grafana-stats.png" alt="grafana graph"></a></p>
<p>With queries looking something like this:</p>
<pre><code>aliasByNode(nonNegativeDerivative(ns*.stevem.io.bind.counter.nsstat.{Requestv4,QryNXDOMAIN,QryFailure,QryAuthAns,QrySuccess}), 0, 6)
</code></pre><p>Pretty simple! Ask questions if you have &lsquo;em.</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://www.stevem.io/post/paperclip-s3-minio-rails/">
                <span class="button__icon">←</span>
                <span class="button__text">using rails 5 and paperclip s3 with minio</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://www.stevem.io/post/getting-started-with-openshift-v3-on-vmware/">
                <span class="button__text">getting started with openshift v3 on vmware</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2020 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://www.stevem.io/assets/main.js"></script>
<script src="https://www.stevem.io/assets/prism.js"></script>







  
</div>

</body>
</html>
